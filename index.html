<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Score Board</title>
    <link rel="stylesheet" href="css/vendor/semantic.min.css"/>
    <link rel="stylesheet" href="css/style.css"/>
  </head>
  <body>
    <div id="container">Loading...</div>
    <script src="js/vendor/react.js"></script>
    <script src="js/vendor/react-dom.js"></script>
    <script src="js/vendor/babel.min.js"></script>
    <script src="js/vendor/prop-types.min.js"></script>
    <script type="text/babel">
      var PLAYERS = [
        {
          name: "Ana Siu",
          score: 20,
          id: 1,
        },
        {
          name: "Andrew Hoskins",
          score: 30,
          id: 2,
        },
        {
          name: "Linda Smith",
          score: 15,
          id: 3,
        }
      ];

      var nextId = PLAYERS.length + 1;

      class Application extends React.Component{
        constructor(props) {
          super(props);
          this.state = {
            players: this.props.initialPlayers
          };
          this.onPlayerAdd = this.onPlayerAdd.bind(this);
          this.onRemovePlayer = this.onRemovePlayer.bind(this);
        }

        onScoreChange(index, delta) {
          this.state.players[index].score += delta;
          this.setState(this.state);
        }

        onPlayerAdd(name) {
          if(name != "") {
            this.state.players.push({
              name: name,
              score: 0,
              id: nextId,
            });
            this.setState(this.state);
            nextId = nextId + 1;
          }
        }

        onRemovePlayer(index) {
            this.state.players.splice(index, 1);
            this.setState(this.state);
        }

        render() {
          return(
            <div className="app">
              <Header title="Score Board" players={this.state.players}/>
              <div className="players">
                {this.state.players.map(function(player, index){
                  return(
                    <Player
                      onRemove={function(){this.onRemovePlayer(index)}.bind(this)}
                      onScoreChange={function(delta){this.onScoreChange(index, delta)}.bind(this)}
                      name={player.name}
                      score={player.score}
                      key={player.id}
                    />
                  );
                }.bind(this))}
              </div>
              <AddPlayerForm onAdd={this.onPlayerAdd}/>
            </div>
          );
        }
      }

      function Player(props) {
        return(
          <div className="player">
            <div className="player-name">
              <a className="remove-player" onClick={props.onRemove}><i class="window close large icon"></i></a>
              {props.name}
            </div>
            <div className="player-score">
              <Counter score={props.score} onChange={props.onScoreChange}/>
            </div>
          </div>
        );
      }

      Player.propTypes = {
        name: PropTypes.string.isRequired,
        score: PropTypes.string.isRequired,
        onScoreChange: PropTypes.func.isRequired,
        onRemove: PropTypes.func.isRequired,
      }

      function Counter(props) {
        return(
          <div className="counter">
            <button className="ui inverted blue button" onClick={function(){props.onChange(-1);}}> - </button>
            <div>{props.score}</div>
            <button className="ui inverted blue button" onClick={function(){props.onChange(1);}}> + </button>
          </div>
        );
      }

      Counter.propTypes = {
        score: PropTypes.number.isRequired,
        onChange: PropTypes.func.isRequired,
      }

      function Header(props) {
        return(
          <div className="header">
            <Stats className="statsComps" players={props.players}/>
            <h1 className="title">{props.title}</h1>
            <Stopwatch className="stopwatchComps"/>
          </div>
        );
      }

      Header.propTypes = {
        title: PropTypes.string.isRequired,
        players: PropTypes.array.isRequired,
      }

      function Stats(props) {
        var totalPlayers = props.players.length;
        var totalPoints = props.players.reduce(function(total, player){
          return total + player.score;
        }, 0);

        return(
          <table className="stats medium text">
            <tbody>
              <tr>
                <td>Players:</td>
                <td>{totalPlayers}</td>
              </tr>
              <tr>
                <td>Total Points:</td>
                <td>{totalPoints}</td>
              </tr>
            </tbody>
          </table>
        );
      }

      Stats.propTypes = {
          players: PropTypes.array.isRequired,
      }

      class AddPlayerForm extends React.Component{
          constructor(props) {
            super(props);
            this.state = {
              name: "",
            }
            this.onSubmit = this.onSubmit.bind(this);
            this.onNameChange = this.onNameChange.bind(this);
          }

          static propTypes = {
            onAdd: PropTypes.func.isRequired,
          }

          onNameChange(e) {
            this.setState({
              name: e.target.value
            });
          }

          onSubmit(e) {
            e.preventDefault();
            this.props.onAdd(this.state.name);
            this.setState({
              name: "",
            });
          }

          render() {
            return(
              <div className="add-player-form ui inverted form">
                <form onSubmit={this.onSubmit}>
                  <div className="ui input">
                    <input type="text" value={this.state.name} onChange={this.onNameChange.bind(this)}/>
                  </div>
                  <input className="ui button" type="submit" value="Add Player"/>
                </form>
              </div>
            );
          }
      }

      class Stopwatch extends React.Component{
          constructor(props) {
            super(props);
            this.state = {
              running: false,
              elapsedTime: 0,
              previousTime: 0,
            }

            this.onTick = this.onTick.bind(this);
            this.onStop = this.onStop.bind(this);
            this.onStart = this.onStart.bind(this);
            this.onReset = this.onReset.bind(this);
          }

          componentDidMount() {
            this.interval = setInterval(this.onTick, 100);
          }

          componentWillUnmount() {
            clearInterval(this.interval);
          }

          onTick() {
            if(this.state.running) {
              var now = Date.now();
              this.setState({
                previousTime: now,
                elapsedTime: this.state.elapsedTime + (now - this.state.previousTime),
              });
            }
          }

          onStop() {
            this.setState({
              running:false,
            })
          }

          onStart() {
            this.setState({
              running: true,
              previousTime: Date.now(),
            })
          }

          onReset() {
            this.setState({
              elapsedTime: 0,
              previousTime: Date.now(),
            })
          }

          render() {
            var seconds = Math.floor(this.state.elapsedTime / 1000);
            return(
              <div className="stopWatch">
                <h4>Stopwatch</h4>
                <div className="stopwatch-time medium text">{seconds}</div>
                {this.state.running ? <button className="ui inverted teal button" onClick={this.onStop}>Stop</button> : <button className="ui inverted teal button" onClick={this.onStart}>Start</button>}
                <button className="ui inverted button" onClick={this.onReset}>Reset</button>
              </div>
            );
          }
      }

      ReactDOM.render(<Application initialPlayers={PLAYERS}/>, document.getElementById('container'));
    </script>
  </body>
</html>
